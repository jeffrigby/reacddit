# Reacddit API

Koa.js OAuth2 server for Reddit authentication (TypeScript). Handles ONLY authentication - no other Reddit API operations.

## Commands

```bash
npm start              # Development server with nodemon + tsx
npm run type-check     # TypeScript type checking
npm test               # Run tests with Vitest
npm run build          # SAM build for Lambda deployment (requires Docker)
```

## TypeScript Standards

- ES2023 target with strict mode
- Zero `any` types - always define proper types
- Explicit return types required on all functions
- Process env access uses bracket notation: `process.env['KEY']`
- Types location: `src/types/`

## Environment Configuration

**File:** `api/.env` (created by setup wizard)

**Required variables:**
- `REDDIT_CLIENT_ID` - OAuth app client ID
- `REDDIT_CLIENT_SECRET` - OAuth app client secret
- `REDDIT_CALLBACK_URI` - Must match domain/port (e.g., `https://localhost:5173/api/callback`)
- `SALT` - 32-character hex string for AES-256-CBC encryption (auto-generated by wizard)
- `CLIENT_PATH` - Client URL for redirects

**Configuration pattern:**
- `src/config.ts` centralizes all environment validation
- Use `config` object instead of direct `process.env` access
- Validates on startup - fails fast with clear errors

## OAuth Flow

1. Client requests `/api/bearer` (anonymous) or `/api/authorize` (user auth)
2. User auth redirects to Reddit OAuth
3. Reddit redirects to `/api/callback` with code
4. API exchanges code for tokens, encrypts, stores in session
5. Subsequent requests include encrypted token in session cookie

**Session management:**
- Koa-session with signed cookies
- Tokens encrypted with AES-256-CBC using `SALT`
- See `src/util.ts` for encryption helpers

## Key Files

- `src/app.ts` - Koa server, routes, middleware
- `src/config.ts` - Environment configuration with validation
- `src/util.ts` - Encryption helpers (encrypt/decrypt tokens)
- `src/types/` - TypeScript type definitions
- `template.yaml` - SAM CloudFormation template for AWS Lambda deployment

## SAM Deployment

**Build:** `npm run build` (requires Docker)
- Uses SAM CLI with esbuild for bundling
- Workspace-aware - finds hoisted dependencies automatically
- No `--build-in-source` flag needed (we don't have cross-workspace imports)

**Template:** `template.yaml`
- Lambda function (Node.js 22)
- API Gateway integration
- Environment variables from Parameter Store

## Testing

**Framework:** Vitest

**Patterns:**
- Test OAuth flows with mocked Reddit API
- Validate encryption/decryption
- Test configuration validation
- API endpoint responses

**Run tests:** `npm test`

## Code Quality

- Run `npm run type-check` before committing
- Zero TypeScript errors required
- Follow same linting standards as root (ESLint v9 flat config)
